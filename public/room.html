<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Watch Room</title>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #121212; color: #fff; height: 100vh; display: flex; flex-direction: column; }
    .top-bar { display: flex; align-items: center; justify-content: space-between; background: #1e1e1e; padding: 10px 20px; border-bottom: 1px solid #333; height: 70px; }
    .avatar-box { display: flex; align-items: center; gap: 10px; }
    .avatar { width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: bold; color: #fff; }
    .room-info { font-size: 16px; }
    .controls { display: flex; gap: 10px; align-items: center; }
    .controls button { background: #2e7d32; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .controls button:hover { background: #1b5e20; }
    .controls button.subtitle-btn { background: #ff9800; }
    .controls button.subtitle-btn:hover { background: #e68900; }
    .user-list { display: flex; gap: 16px; align-items: center; position: absolute; left: 50%; transform: translateX(-50%); }
    .user-container { display: flex; flex-direction: column; align-items: center; font-size: 12px; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold; margin-bottom: 4px; }
    .user-name { margin-top: 2px; }

    .main { flex: 1; display: flex; overflow: hidden; }
    .video-container { flex: 3; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
    video { max-width: 100%; max-height: 100%; background: #000; object-fit: contain; }
    #videoPlayer { width: 100%; height: 100%; object-fit: contain; }
    #status { position: absolute; color: #00e5ff; }

    /* Subtitle styling */
    #videoPlayer::cue {
      background-color: rgba(0, 0, 0, 0.8);
      color: #ffffff;
      font-size: 20px;
      font-family: Arial, sans-serif;
      text-align: center;
      line-height: 1.2;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .subtitle-controls {
      position: absolute;
      bottom: 60px;
      right: 20px;
      background: rgba(0, 0, 0, 0.8);
      padding: 10px;
      border-radius: 8px;
      display: none;
      z-index: 100;
    }

    .subtitle-controls.active {
      display: block;
    }

    .subtitle-controls button {
      background: #333;
      color: #fff;
      border: none;
      padding: 6px 12px;
      margin: 2px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .subtitle-controls button:hover {
      background: #555;
    }

    .subtitle-controls button.active {
      background: #ff9800;
    }

    .subtitle-upload {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #555;
    }

    .subtitle-upload input[type="file"] {
      width: 100%;
      padding: 4px;
      background: #444;
      border: 1px solid #666;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
    }

    #splitter { width: 5px; cursor: col-resize; background: rgba(255,255,255,0.2); z-index: 10; }

    /* YouTube-style chat */
    .chat-container { flex: 1; display: flex; flex-direction: column; border-left: 1px solid #333; background: #181818; min-width: 300px; }
    .chat-header { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #202020; border-bottom: 1px solid #333; font-size: 14px; }
    .chat-header button { background: none; border: none; color: #fff; font-size: 18px; cursor: pointer; }
    #chat { flex: 1; overflow-y: auto; padding: 8px; display: flex; flex-direction: column-reverse; }
    .chat-message { display: flex; align-items: flex-start; margin-bottom: 16px; }
    .chat-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; flex-shrink: 0; margin-top: 4px;
                   display: flex; align-items: center; justify-content: center; background: #555; color: #fff; font-size: 14px; font-weight: bold; }
    .chat-content { background: rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 16px; max-width: 100%; display: inline-block; position: relative; }
    .chat-content .username { font-weight: bold; font-size: 13px; margin-right: 6px; color: #fff; }
    .chat-content .message { font-size: 14px; line-height: 1.3; color: #e0e0e0; }
    .chat-content .timestamp { font-size: 11px; color: #aaa; margin-left: 6px; }
    
    /* System message styling */
    .system-message { justify-content: center; margin-bottom: 8px; }
    .system-message .chat-content { 
      background: rgba(255, 193, 7, 0.2); 
      color: #ffc107; 
      font-style: italic; 
      text-align: center; 
      font-size: 12px; 
      padding: 4px 8px;
      border-radius: 12px;
    }

    #chatInput { display: flex; padding: 10px; border-top: 1px solid #333; background: #202020; }
    #chatInput input { flex: 1; padding: 8px 12px; border: none; border-radius: 20px; background: #303030; color: #fff; font-size: 14px; }
    #chatInput button { margin-left: 10px; padding: 8px 16px; background: #065fd4; border: none; border-radius: 20px; color: #fff; font-size: 14px; cursor: pointer; }
    #chatInput button:hover { background: #054aba; }

    .notification-container { position: fixed; top: 80px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
    .notification { 
      background: #272727; 
      color: #e0e0e0; 
      padding: 12px 16px; 
      border-radius: 6px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.5); 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      min-width: 240px; 
      animation: slideIn 0.3s ease-out;
    }
    .notification span { flex: 1; }
    .notification .actions { display: flex; gap: 8px; margin-left: 10px; }
    .notification button { 
      background: transparent; 
      border: none; 
      padding: 4px; 
      cursor: pointer;
      transition: opacity 0.2s;
    }
    .notification button.approve { color: #4CAF50; }
    .notification button.deny { color: #f44336; }
    .notification button:hover { opacity: 0.8; }

    @keyframes slideIn { 
      from { transform: translateX(100%); opacity: 0; } 
      to { transform: translateX(0); opacity: 1; } 
    }

    #fileInput, #subtitleInput { display: none; }

    /* UPLOAD PROGRESS BAR */
    .progress-container {
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      width: 80%;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      display: none;
      z-index: 5;
    }
    .progress-bar {
      height: 100%;
      width: 0;
      background: #28a745;
      transition: width 0.2s ease;
    }
    #progress-text {
      position: absolute;
      bottom: 35px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 14px;
      color: #00e5ff;
      display: none;
      z-index: 5;
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div class="avatar-box">
      <div class="avatar" id="avatar">A</div>
      <div class="room-info">
        <div><strong id="usernameDisplay">Anon</strong></div>
        <div>Room: <span id="roomIdDisplay"></span></div>
      </div>
    </div>
    <div class="controls">
      <button id="actionBtn">üîÑ Change Media</button>
      <button id="subtitleBtn" class="subtitle-btn">üìù Subtitles</button>
      <button id="toggleChat">üí¨ Chat</button>
      <button id="endSessionBtn" style="display:none;">üõë End Session</button>
      <button id="leaveRoomBtn" style="display:none;">üëã Leave Room</button>
    </div>
    <div class="user-list" id="userList"></div>
  </div>

  <input type="file" id="fileInput" accept="video/*,audio/*">
  <input type="file" id="subtitleInput" accept=".srt,.vtt,.ass,.ssa" multiple>

  <div class="main">
    <div class="video-container" id="videoContainer">
      <video id="videoPlayer" controls style="display:none;" crossorigin="anonymous"></video>
      <div id="status">Loading‚Ä¶</div>

      <!-- Subtitle Controls -->
      <div class="subtitle-controls" id="subtitleControls">
        <div>
          <button id="subtitleOff" class="active">Off</button>
          <div id="subtitleTracks"></div>
        </div>
        <div class="subtitle-upload">
          <label for="subtitleInput" style="color: #ccc; font-size: 12px;">Upload Subtitle Files:</label>
          <input type="file" id="subtitleFileInput" accept=".srt,.vtt,.ass,.ssa" multiple style="margin-top: 4px;">
        </div>
      </div>

      <!-- progress bar UI -->
      <div class="progress-container" id="uploadProgress">
        <div class="progress-bar"></div>
      </div>
      <div id="progress-text"></div>
    </div>
    <div id="splitter"></div>
    <div class="chat-container" id="chatContainer" style="display:flex;">
      <div class="chat-header">
        <span>Live Chat</span>
        <button id="closeChat">√ó</button>
      </div>
      <div id="chat"></div>
      <div id="chatInput">
        <input id="msg" placeholder="Say something‚Ä¶">
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <div class="notification-container" id="notifications"></div>
  <form id="uploadForm" method="POST" enctype="multipart/form-data" style="display:none;"></form>

<script src="/socket.io/socket.io.js"></script>
<script>
(async () => {
    const roomId         = location.pathname.split('/').pop();
    const username       = sessionStorage.getItem('username') || 'Anon';
    const avatarEl       = document.getElementById('avatar');
    const actionBtn      = document.getElementById('actionBtn');
    const subtitleBtn    = document.getElementById('subtitleBtn');
    const fileInput      = document.getElementById('fileInput');
    const subtitleInput  = document.getElementById('subtitleInput');
    const subtitleFileInput = document.getElementById('subtitleFileInput');
    const subtitleControls = document.getElementById('subtitleControls');
    const toggleChat     = document.getElementById('toggleChat');
    const closeChat      = document.getElementById('closeChat');
    const chatContainer  = document.getElementById('chatContainer');
    const videoContainer = document.getElementById('videoContainer');
    const endBtn         = document.getElementById('endSessionBtn');
    const leaveBtn       = document.getElementById('leaveRoomBtn');
    const notifications  = document.getElementById('notifications');
    const chatBox        = document.getElementById('chat');
    const msgInput       = document.getElementById('msg');
    const sendBtn        = document.getElementById('send');

    // Progress UI
    const progressContainer = document.getElementById('uploadProgress');
    const progressBar       = progressContainer.querySelector('.progress-bar');
    const progressText      = document.getElementById('progress-text');

    // Display room & user
    document.getElementById('roomIdDisplay').textContent = roomId;
    document.getElementById('usernameDisplay').textContent = username;
    avatarEl.textContent = username.charAt(0).toUpperCase();

    // Chat history is now handled server-side
    let chatHistory = [];

    // Subtitle management
    let availableSubtitles = [];
    let currentSubtitle = null;

    // Assign each user a consistent HSL color
    function stringToColor(name) {
      let hash = 0;
      for (let c of name) hash = c.charCodeAt(0) + ((hash << 5) - hash);
      return `hsl(${Math.abs(hash) % 360},50%,30%)`;
    }
    const myColor = stringToColor(username);
    avatarEl.style.background = myColor;

    // Admin / temp‚Äëadmin state
    let isAdmin       = sessionStorage.getItem(`isAdmin_${roomId}`) === 'true';
    const hasTempAccess = sessionStorage.getItem(`tempAdmin_${roomId}`) === 'true';

    // Countdown state
    let countdownActive = false;
    const existingEnd   = localStorage.getItem(`countdown_endTime_${roomId}`);
    if (existingEnd) {
      const remaining = Math.ceil((+existingEnd - Date.now())/1000);
      if (remaining > 0) {
        countdownActive = true;
        startCountdown(remaining);
      } else {
        localStorage.removeItem(`countdown_endTime_${roomId}`);
      }
    }

    // Subtitle functionality
    function loadAvailableSubtitles() {
      fetch(`/subtitles/${roomId}`)
        .then(res => res.json())
        .then(data => {
          availableSubtitles = data.subtitles || [];
          updateSubtitleControls();
        })
        .catch(err => console.log('No subtitles available'));
    }

    function updateSubtitleControls() {
      const tracksContainer = document.getElementById('subtitleTracks');
      tracksContainer.innerHTML = '';
      
      availableSubtitles.forEach((sub, index) => {
        const btn = document.createElement('button');
        btn.textContent = sub.name || `Track ${index + 1}`;
        btn.onclick = () => setSubtitle(sub.file);
        tracksContainer.appendChild(btn);
      });
    }

    function setSubtitle(filename) {
      const video = document.getElementById('videoPlayer');
      
      // Remove existing subtitle tracks
      const existingTracks = video.querySelectorAll('track[kind="subtitles"]');
      existingTracks.forEach(track => track.remove());
      
      if (filename) {
        const track = document.createElement('track');
        track.kind = 'subtitles';
        track.src = `/subtitles/${roomId}/${filename}`;
        track.srclang = 'en';
        track.label = filename.replace(/\.[^/.]+$/, "");
        track.default = true;
        video.appendChild(track);
        
        // Update button states
        document.querySelectorAll('#subtitleControls button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
      } else {
        // Turn off subtitles
        document.querySelectorAll('#subtitleControls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById('subtitleOff').classList.add('active');
      }
      
      currentSubtitle = filename;
      
      // Sync subtitle choice with other users
      socket.emit('subtitle-change', { roomId, subtitle: filename });
    }

    // Subtitle button toggle
    subtitleBtn.onclick = () => {
      const isVisible = subtitleControls.classList.contains('active');
      if (isVisible) {
        subtitleControls.classList.remove('active');
      } else {
        subtitleControls.classList.add('active');
        loadAvailableSubtitles();
      }
    };

    // Subtitle off button
    document.getElementById('subtitleOff').onclick = () => setSubtitle(null);

    // Subtitle file upload
    subtitleFileInput.onchange = () => {
      const files = Array.from(subtitleFileInput.files);
      if (files.length === 0) return;

      const formData = new FormData();
      files.forEach(file => {
        formData.append('subtitles', file);
      });

      fetch(`/upload-subtitles/${roomId}`, {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          loadAvailableSubtitles();
          showNotification(`Uploaded ${files.length} subtitle file(s)`);
        } else {
          showNotification('Failed to upload subtitles', 'error');
        }
      })
      .catch(err => {
        console.error('Subtitle upload error:', err);
        showNotification('Error uploading subtitles', 'error');
      });
      
      subtitleFileInput.value = '';
    };

    function showNotification(message, type = 'success') {
      const note = document.createElement('div');
      note.className = 'notification';
      note.style.background = type === 'error' ? '#f44336' : '#4CAF50';
      note.innerHTML = `<span>${message}</span>`;
      notifications.appendChild(note);
      setTimeout(() => note.remove(), 3000);
    }

    // Hide subtitle controls when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!subtitleBtn.contains(e.target) && !subtitleControls.contains(e.target)) {
        subtitleControls.classList.remove('active');
      }
    });

    // Render one chat message (YouTube‚Äëstyle)
    function append(name, message, color, timestamp = null) {
      const msgEl = document.createElement('div');
      msgEl.className = 'chat-message';
      const avatar = document.createElement('div');
      avatar.className = 'chat-avatar';
      avatar.style.background = color;
      avatar.textContent = name.charAt(0).toUpperCase();
      const content = document.createElement('div');
      content.className = 'chat-content';
      const uname = document.createElement('span');
      uname.className = 'username';
      uname.textContent = name;
      const msg  = document.createElement('span');
      msg.className = 'message';
      msg.textContent = message;
      const ts   = document.createElement('span');
      ts.className = 'timestamp';
      
      // Use provided timestamp or create new one
      const timeToUse = timestamp ? new Date(timestamp) : new Date();
      ts.textContent = timeToUse.getHours().toString().padStart(2,'0')
                   + ':' + timeToUse.getMinutes().toString().padStart(2,'0');
      
      content.append(uname, msg, ts);
      msgEl.append(avatar, content);
      chatBox.insertBefore(msgEl, chatBox.firstChild);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Function to refresh chat display with current history
    function refreshChatDisplay() {
      // Clear current chat display
      chatBox.innerHTML = '';
      // Display current chat history
      chatHistory.forEach(m => {
        const originalTimestamp = m.timestamp || null;
        append(m.name, m.message, stringToColor(m.name) || myColor, originalTimestamp);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Unified send logic
    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      // Just emit the message - server will handle timestamp and broadcasting
      socket.emit('chat-message', { roomId, msg: text });
      msgInput.value = '';
    }
    sendBtn.onclick = sendMessage;
    msgInput.addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Action button logic
    function updateActionButton() {
      if (isAdmin || hasTempAccess) {
        actionBtn.textContent = 'üîÑ Change Media';
        actionBtn.onclick = () => fileInput.click();
        actionBtn.disabled = false;
      } else if (countdownActive) {
        actionBtn.disabled = true;
      } else {
        actionBtn.textContent = 'üîÑ Request Change';
        actionBtn.onclick = () => {
          socket.emit('request-change', { roomId, name: username });
          startCountdown(30);
        };
        actionBtn.disabled = false;
      }
    }
    updateActionButton();

    function startCountdown(sec) {
      let t = sec;
      countdownActive = true;
      actionBtn.disabled = true;
      const endTime = Date.now() + t*1000;
      localStorage.setItem(`countdown_endTime_${roomId}`, endTime.toString());
      window.currentCountdownInterval = setInterval(() => {
        actionBtn.textContent = `Wait (${t--}s)`;
        if (t < 0) {
          clearInterval(window.currentCountdownInterval);
          countdownActive = false;
          localStorage.removeItem(`countdown_endTime_${roomId}`);
          updateActionButton();
        }
      }, 1000);
    }

    // Media upload with progress
    fileInput.onchange = () => {
      const file = fileInput.files[0];
      if (!file) return;

      const xhr = new XMLHttpRequest();
      const url = `/upload/${roomId}`;
      const fd  = new FormData();
      fd.append('video', file);

      xhr.open('POST', url, true);

      // show upload UI
      progressContainer.style.display = 'block';
      progressText.style.display      = 'block';
      progressText.textContent        = 'Uploading: 0%';
      progressBar.style.width         = '0%';
      document.getElementById('status').textContent = 'Uploading‚Ä¶';

      xhr.upload.onprogress = e => {
        if (e.lengthComputable) {
          const pct = Math.round((e.loaded / e.total) * 100);
          progressBar.style.width    = pct + '%';
          progressText.textContent   = `Uploading: ${pct}%`;
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          progressBar.style.width    = '100%';
          progressText.textContent   = 'Upload complete! Reloading‚Ä¶';
          setTimeout(() => location.reload(), 700);
        } else {
          progressText.textContent = 'Upload failed. Try again.';
        }
      };

      xhr.onerror = () => {
        progressText.textContent = 'Error during upload.';
      };

      xhr.send(fd);
    };

    // Updated chat toggle with history refresh
    toggleChat.onclick = () => {
      const open = chatContainer.style.display === 'flex';
      if (open) {
        // Closing chat
        chatContainer.style.display = 'none';
        videoContainer.style.flex = '1';
      } else {
        // Opening chat - refresh the chat history first
        refreshChatDisplay();
        chatContainer.style.display = 'flex';
        videoContainer.style.flex = '2';
      }
    };
    closeChat.onclick = () => {
      chatContainer.style.display = 'none';
      videoContainer.style.flex = '1';
    };

    // End session (admin only) / Leave room (participants)
    function updateButtons() {
      if (isAdmin) {
        endBtn.style.display = 'inline';
        leaveBtn.style.display = 'none';
      } else {
        endBtn.style.display = 'none';
        leaveBtn.style.display = 'inline';
      }
    }
    updateButtons();

    endBtn.onclick = async () => {
      if (!confirm('End session for everyone? This will close the room.')) return;
      const res = await fetch(`/end/${roomId}`, { method: 'POST' });
      if ((await res.json()).success) location = '/';
    };

    leaveBtn.onclick = () => {
      if (!confirm('Leave this room?')) return;
      socket.emit('leave-room', { roomId });
      location = '/';
    };

    // socket.io setup
    const socket = io();
    socket.emit('join-room', { roomId, name: username });

    // Participant list
    const used = new Set([myColor]);
    socket.on('users-updated', users => {
      document.getElementById('userList').innerHTML = users.map(u => {
        let bg = stringToColor(u.name);
        while (used.has(bg)) {
          const [h,s,l] = bg.match(/\d+/g);
          bg = `hsl(${h},${s}%,${Math.max(20,Math.min(40,+l + (Math.random()*10-5)))}%)`;
        }
        used.add(bg);
        return `
          <div class="user-container">
            <div class="user-avatar" style="background:${bg}">
              ${u.name.charAt(0).toUpperCase()}
            </div>
            <div class="user-name">${u.name}</div>
          </div>`;
      }).join('');
    });

    // Admin status update
    socket.on('admin-status', ({ isAdminUser }) => {
      isAdmin = isAdminUser;
      if (isAdmin) {
        sessionStorage.setItem(`isAdmin_${roomId}`, 'true');
      } else {
        sessionStorage.removeItem(`isAdmin_${roomId}`);
      }
      updateButtons();
    });

    // Change requests & grants
    socket.on('change-request', ({ from, requesterId }) => {
      if (!isAdmin) return;
      const note = document.createElement('div');
      note.className = 'notification';
      note.innerHTML = `
        <span>${from} wants to change media</span>
        <div class="actions">
          <button class="approve">‚úÖ</button>
          <button class="deny">‚ùå</button>
        </div>`;
      note.querySelector('.approve').onclick = () => {
        socket.emit('grant-change', { roomId, requesterId });
        note.remove();
      };
      note.querySelector('.deny').onclick = () => note.remove();
      notifications.appendChild(note);
      setTimeout(() => note.remove(), 10000);
    });
    socket.on('change-granted', () => {
      if (isAdmin) return;
      sessionStorage.setItem(`tempAdmin_${roomId}`, 'true');
      countdownActive = false;
      localStorage.removeItem(`countdown_endTime_${roomId}`);
      clearInterval(window.currentCountdownInterval);
      actionBtn.textContent = 'üîÑ Change Media';
      actionBtn.disabled = false;
      actionBtn.onclick = () => fileInput.click();
      const note = document.createElement('div');
      note.className = 'notification';
      note.innerHTML = '<span>Permission granted!</span>';
      notifications.appendChild(note);
      setTimeout(() => note.remove(), 5000);
    });

    // Subtitle sync
    socket.on('subtitle-change', ({ subtitle }) => {
      if (subtitle !== currentSubtitle) {
        setSubtitle(subtitle);
      }
    });

    // Media changed
    socket.on('media-changed', () => {
      localStorage.removeItem(`countdown_endTime_${roomId}`);
      location.reload();
    });

    // Session end
    socket.on('session-ended', () => {
      localStorage.removeItem(`countdown_endTime_${roomId}`);
      location = '/';
    });

    // Load initial video
    const data = await (await fetch(`/files/${roomId}`)).json();
    if (!data.video) return showError('No media');
    const video = document.getElementById('videoPlayer');
    video.src = `/uploads/${roomId}/${data.video}`;
    video.style.display = 'block';
    document.getElementById('status').style.display = 'none';

    // Load available subtitles
    loadAvailableSubtitles();

    // Initial chat display
    refreshChatDisplay();

    // Server sends chat history when user joins
    socket.on('chat-history', (history) => {
      chatHistory = history;
      refreshChatDisplay();
    });

    // Incoming chat messages from server
    socket.on('chat-message', ({ name, message, timestamp }) => {
      append(name, message, stringToColor(name) || myColor, timestamp);
      chatHistory.push({ name, message, timestamp });
    });

    // Video sync logic
    let sync = false, last = 0;
    function emit(action) {
      if (!sync) socket.emit('video-action', { roomId, action, time: video.currentTime });
    }
    video.addEventListener('play', () => emit('play'));
    video.addEventListener('pause', () => emit('pause'));
    video.addEventListener('seeking', () => emit('seek'));
    video.addEventListener('timeupdate', () => {
      const now = Date.now();
      if (now - last > 1000) { last = now; emit('sync'); }
    });
    socket.on('video-action', ({ action, time }) => {
      sync = true;
      if (['seek','sync'].includes(action) && Math.abs(video.currentTime - time) > 0.2) {
        video.currentTime = time;
      }
      if (action === 'play') { if (Math.abs(video.currentTime - time) > 0.2) video.currentTime = time; video.play(); }
      if (action === 'pause') { if (Math.abs(video.currentTime - time) > 0.2) video.currentTime = time; video.pause(); }
      setTimeout(() => sync = false, 50);
    });

    // Panel splitter drag
    const splitter = document.getElementById('splitter');
    let dragging = false;
    splitter.addEventListener('mousedown', () => {
      dragging = true;
      document.body.style.cursor = 'col-resize';
    });
    window.addEventListener('mouseup', () => {
      dragging = false;
      document.body.style.cursor = '';
    });
    window.addEventListener('mousemove', e => {
      if (!dragging) return;
      const rect = document.querySelector('.main').getBoundingClientRect();
      let x = e.clientX - rect.left;
      const min = 150, max = rect.width - 150;
      x = Math.max(min, Math.min(max, x));
      videoContainer.style.flex = `0 0 ${x}px`;
      document.querySelector('.chat-container').style.flex = '1';
    });

})(); // end async

function showError(msg) {
  const s = document.getElementById('status');
  s.textContent = msg;
  s.style.color = '#f55';
}

// Hide top-bar on inactivity
const topBar = document.querySelector('.top-bar');
let hideBarTimer;
function hideTopBar() { topBar.style.display = 'none'; }
function resetHideTimer() {
  topBar.style.display = 'flex';
  clearTimeout(hideBarTimer);
  hideBarTimer = setTimeout(hideTopBar, 10000);
}
document.addEventListener('mousemove', resetHideTimer);
resetHideTimer();
</script>
</body>
</html>
